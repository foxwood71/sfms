FROM node:20-alpine

# 1. pnpm 전역 설치 (설계서 기술 스택 반영)
RUN npm install -g pnpm  # 전역 설치는 루트 권한이 필요하므로 가장 먼저 실행합니다.

WORKDIR /app

# 2. Podman Rootless 환경을 위한 폴더 소유권 변경
# 호스트의 일반 사용자(UID 1000) 권한과 매핑되도록 /app 폴더를 내장된 'node' 사용자에게 넘깁니다.
RUN chown -R node:node /app

# 3. 비루트 사용자(non-root user) 전환
# 이후 진행되는 패키지 설치와 코드 복사 등을 모두 일반 사용자로 진행하여 보안을 극대화합니다.
USER node

# 4. 패키지 의존성 파일 먼저 복사 (캐시 최적화)
# pnpm-lock.yaml이 아직 없다면 무시되도록 와일드카드(*) 사용
# --chown 옵션을 사용하여 복사하는 파일의 주인을 'node'로 확실히 지정합니다.
COPY --chown=node:node package.json pnpm-lock.yaml* ./

# 5. 패키지 설치
RUN pnpm install  # 일반 사용자 권한으로 안전하게 node_modules를 생성합니다.

# 6. 소스 코드 전체 복사
COPY --chown=node:node . .

# 7. Vite 기본 개발 포트 명시 (도큐멘테이션 목적)
EXPOSE 5173

# 8. 개발 서버 실행 (외부 접속 허용을 위해 --host 0.0.0.0 필수)
CMD ["pnpm", "run", "dev", "--host", "0.0.0.0"]